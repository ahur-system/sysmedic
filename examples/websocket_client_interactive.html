<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysMedic Interactive WebSocket Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .connection-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        input[type="text"] {
            flex: 1;
            min-width: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 2px;
        }
        .connect-btn {
            background-color: #4CAF50;
            color: white;
        }
        .disconnect-btn {
            background-color: #f44336;
            color: white;
        }
        .request-btn {
            background-color: #2196F3;
            color: white;
        }
        .clear-btn {
            background-color: #ff9800;
            color: white;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .request-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .logs {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 8px;
            border-radius: 3px;
        }
        .log-welcome {
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
        }
        .log-system {
            background-color: #f0f8f0;
            border-left: 4px solid #4CAF50;
        }
        .log-response {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
        }
        .log-alert {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
        }
        .log-error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
        }
        .log-info {
            background-color: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        .timestamp {
            color: #666;
            font-size: 12px;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric-label {
            color: #666;
            font-size: 14px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .cpu-bar { background-color: #2196F3; }
        .memory-bar { background-color: #4CAF50; }
        .disk-bar { background-color: #ff9800; }
        .example-urls {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .example-urls h4 {
            margin-top: 0;
            color: #333;
        }
        .example-url {
            font-family: monospace;
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            word-break: break-all;
        }
        .response-data {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .pending-requests {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üñ•Ô∏è SysMedic Interactive WebSocket Client</h1>

    <div class="container">
        <h2>Connection</h2>

        <div class="example-urls">
            <h4>Example URLs:</h4>
            <div class="example-url">sysmedic://abc123def456@localhost:8060/</div>
            <div class="example-url">sysmedic://d8852f78260f16d31eeff80ca6158848@server.example.com:8060/</div>
            <p><strong>Note:</strong> Get your actual connection URL from: <code>sysmedic websocket status</code></p>
        </div>

        <div class="connection-form">
            <input type="text" id="connectionUrl" placeholder="Enter SysMedic WebSocket URL (sysmedic://secret@host:port/)" value="">
            <button id="connectBtn" class="connect-btn">Connect</button>
            <button id="disconnectBtn" class="disconnect-btn" disabled>Disconnect</button>
            <button id="clearBtn" class="clear-btn">Clear Logs</button>
        </div>

        <div id="status" class="status disconnected">Disconnected</div>
    </div>

    <div class="container">
        <h2>Request Information from Server</h2>
        <p>Click buttons below to request specific information from the SysMedic server:</p>

        <div class="request-panel">
            <button class="request-btn" onclick="requestSystemInfo()">Get System Info</button>
            <button class="request-btn" onclick="requestAlerts()">Get Alerts</button>
            <button class="request-btn" onclick="requestUserMetrics()">Get User Metrics</button>
            <button class="request-btn" onclick="requestConfig()">Get Config</button>
            <button class="request-btn" onclick="requestUptime()">Get Uptime</button>
            <button class="request-btn" onclick="sendPing()">Ping Server</button>
        </div>

        <div id="pendingRequests" class="pending-requests" style="display: none;">
            <strong>Pending Requests:</strong>
            <ul id="pendingList"></ul>
        </div>
    </div>

    <div class="container">
        <h2>Real-time System Metrics</h2>
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-label">CPU Usage</div>
                <div class="metric-value" id="cpuValue">--</div>
                <div class="progress-bar">
                    <div class="progress-fill cpu-bar" id="cpuBar" style="width: 0%"></div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Memory Usage</div>
                <div class="metric-value" id="memoryValue">--</div>
                <div class="progress-bar">
                    <div class="progress-fill memory-bar" id="memoryBar" style="width: 0%"></div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Disk Usage</div>
                <div class="metric-value" id="diskValue">--</div>
                <div class="progress-bar">
                    <div class="progress-fill disk-bar" id="diskBar" style="width: 0%"></div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Uptime</div>
                <div class="metric-value" id="uptimeValue">--</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>Activity Log</h2>
        <div id="logs" class="logs">
            <div class="log-entry log-info">
                <span class="timestamp">[Ready]</span> Enter a SysMedic WebSocket URL and click Connect to start monitoring.
                <br><span class="timestamp">[Info]</span> Once connected, use the request buttons above to ask for specific information.
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let pendingRequests = new Map();
        let requestCounter = 0;

        const elements = {
            connectionUrl: document.getElementById('connectionUrl'),
            connectBtn: document.getElementById('connectBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            clearBtn: document.getElementById('clearBtn'),
            status: document.getElementById('status'),
            logs: document.getElementById('logs'),
            cpuValue: document.getElementById('cpuValue'),
            memoryValue: document.getElementById('memoryValue'),
            diskValue: document.getElementById('diskValue'),
            uptimeValue: document.getElementById('uptimeValue'),
            cpuBar: document.getElementById('cpuBar'),
            memoryBar: document.getElementById('memoryBar'),
            diskBar: document.getElementById('diskBar'),
            pendingRequests: document.getElementById('pendingRequests'),
            pendingList: document.getElementById('pendingList')
        };

        function generateRequestId() {
            return `req_${++requestCounter}_${Date.now()}`;
        }

        function addPendingRequest(requestId, type) {
            pendingRequests.set(requestId, {
                type: type,
                timestamp: Date.now()
            });
            updatePendingDisplay();
        }

        function removePendingRequest(requestId) {
            pendingRequests.delete(requestId);
            updatePendingDisplay();
        }

        function updatePendingDisplay() {
            if (pendingRequests.size > 0) {
                elements.pendingRequests.style.display = 'block';
                elements.pendingList.innerHTML = '';
                for (const [id, req] of pendingRequests) {
                    const li = document.createElement('li');
                    li.textContent = `${req.type} (${id})`;
                    elements.pendingList.appendChild(li);
                }
            } else {
                elements.pendingRequests.style.display = 'none';
            }
        }

        function sendRequest(type, data = null) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Cannot send request: Not connected to server', 'error');
                return;
            }

            const requestId = generateRequestId();
            const request = {
                type: type,
                request_id: requestId,
                data: data
            };

            try {
                ws.send(JSON.stringify(request));
                addPendingRequest(requestId, type);
                log(`üì§ Sent request: ${type} (ID: ${requestId})`, 'info');
            } catch (error) {
                log(`Error sending request: ${error.message}`, 'error');
            }
        }

        function requestSystemInfo() {
            sendRequest('get_system_info');
        }

        function requestAlerts() {
            sendRequest('get_alerts');
        }

        function requestUserMetrics() {
            sendRequest('get_user_metrics');
        }

        function requestConfig() {
            sendRequest('get_config');
        }

        function requestUptime() {
            sendRequest('get_uptime');
        }

        function sendPing() {
            sendRequest('ping');
        }

        function parseConnectionUrl(url) {
            const match = url.match(/^sysmedic:\/\/([^@]+)@([^:]+):(\d+)\/?$/);
            if (!match) {
                throw new Error('Invalid URL format. Expected: sysmedic://secret@host:port/');
            }
            return {
                secret: match[1],
                host: match[2],
                port: parseInt(match[3])
            };
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            elements.logs.appendChild(logEntry);
            elements.logs.scrollTop = elements.logs.scrollHeight;
        }

        function updateStatus(status, className) {
            elements.status.textContent = status;
            elements.status.className = `status ${className}`;
        }

        function updateMetrics(data) {
            if (data.cpu_usage !== undefined) {
                elements.cpuValue.textContent = `${data.cpu_usage.toFixed(1)}%`;
                elements.cpuBar.style.width = `${Math.min(data.cpu_usage, 100)}%`;
            }
            if (data.memory_usage !== undefined) {
                elements.memoryValue.textContent = `${data.memory_usage.toFixed(1)}%`;
                elements.memoryBar.style.width = `${Math.min(data.memory_usage, 100)}%`;
            }
            if (data.disk_usage !== undefined) {
                elements.diskValue.textContent = `${data.disk_usage.toFixed(1)}%`;
                elements.diskBar.style.width = `${Math.min(data.disk_usage, 100)}%`;
            }
            if (data.uptime !== undefined) {
                elements.uptimeValue.textContent = data.uptime;
            }
        }

        function formatResponseData(data) {
            return JSON.stringify(data, null, 2);
        }

        function connect() {
            const url = elements.connectionUrl.value.trim();
            if (!url) {
                log('Please enter a connection URL', 'error');
                return;
            }

            try {
                const parsed = parseConnectionUrl(url);
                const wsUrl = `ws://${parsed.host}:${parsed.port}/ws?secret=${parsed.secret}`;

                log(`Connecting to ${parsed.host}:${parsed.port}...`, 'info');
                updateStatus('Connecting...', 'connecting');

                ws = new WebSocket(wsUrl);

                ws.onopen = function(event) {
                    log('Connected successfully! üéâ', 'welcome');
                    updateStatus(`Connected to ${parsed.host}:${parsed.port}`, 'connected');
                    elements.connectBtn.disabled = true;
                    elements.disconnectBtn.disabled = false;
                    elements.connectionUrl.disabled = true;
                    reconnectAttempts = 0;
                };

                ws.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        handleMessage(message);
                    } catch (e) {
                        log(`Error parsing message: ${e.message}`, 'error');
                    }
                };

                ws.onclose = function(event) {
                    log(`Connection closed (Code: ${event.code})`, 'error');
                    disconnect();

                    if (reconnectAttempts < maxReconnectAttempts && event.code !== 1000) {
                        reconnectAttempts++;
                        log(`Attempting to reconnect... (${reconnectAttempts}/${maxReconnectAttempts})`, 'info');
                        setTimeout(() => {
                            if (ws && ws.readyState === WebSocket.CLOSED) {
                                connect();
                            }
                        }, 3000);
                    }
                };

                ws.onerror = function(error) {
                    log('WebSocket error occurred', 'error');
                    console.error('WebSocket error:', error);
                };

            } catch (e) {
                log(`Connection error: ${e.message}`, 'error');
                updateStatus('Connection failed', 'disconnected');
            }
        }

        function disconnect() {
            if (ws) {
                ws.close(1000, 'User disconnected');
                ws = null;
            }

            updateStatus('Disconnected', 'disconnected');
            elements.connectBtn.disabled = false;
            elements.disconnectBtn.disabled = true;
            elements.connectionUrl.disabled = false;

            // Clear pending requests
            pendingRequests.clear();
            updatePendingDisplay();

            // Reset metrics
            elements.cpuValue.textContent = '--';
            elements.memoryValue.textContent = '--';
            elements.diskValue.textContent = '--';
            elements.uptimeValue.textContent = '--';
            elements.cpuBar.style.width = '0%';
            elements.memoryBar.style.width = '0%';
            elements.diskBar.style.width = '0%';
        }

        function handleMessage(message) {
            const { type, data, timestamp, request_id } = message;

            // Handle responses to requests
            if (request_id) {
                removePendingRequest(request_id);
                log(`üì• Response received for ${request_id}:`, 'response');

                const responseDiv = document.createElement('div');
                responseDiv.className = 'response-data';
                responseDiv.textContent = formatResponseData(data);

                const lastLogEntry = elements.logs.lastElementChild;
                lastLogEntry.appendChild(responseDiv);
                elements.logs.scrollTop = elements.logs.scrollHeight;
                return;
            }

            // Handle regular messages
            switch (type) {
                case 'welcome':
                    log(`Welcome! SysMedic ${data.version} - ${data.message}`, 'welcome');
                    if (data.system) {
                        log(`System: ${data.system}`, 'info');
                    }
                    if (data.status) {
                        log(`Status: ${data.status}`, 'info');
                    }
                    if (data.daemon) {
                        log(`Daemon: ${data.daemon}`, 'info');
                    }
                    log('üí° Tip: Use the request buttons above to ask for specific information', 'info');
                    break;

                case 'system_update':
                    updateMetrics(data);
                    log(`System update: CPU ${data.cpu_usage?.toFixed(1)}%, Memory ${data.memory_usage?.toFixed(1)}%, Disk ${data.disk_usage?.toFixed(1)}%`, 'system');
                    break;

                case 'alert':
                    log(`üö® ALERT: ${data.status} - ${data.primary_cause || 'System under load'}`, 'alert');
                    if (data.recommendations && data.recommendations.length > 0) {
                        data.recommendations.forEach(rec => {
                            log(`üí° Recommendation: ${rec}`, 'alert');
                        });
                    }
                    break;

                case 'error':
                    log(`‚ùå Server Error: ${data.error}`, 'error');
                    break;

                default:
                    log(`Unknown message type: ${type}`, 'info');
                    console.log('Full message:', message);
            }
        }

        function clearLogs() {
            elements.logs.innerHTML = '<div class="log-entry log-info"><span class="timestamp">[Cleared]</span> Logs cleared.</div>';
        }

        // Event listeners
        elements.connectBtn.addEventListener('click', connect);
        elements.disconnectBtn.addEventListener('click', disconnect);
        elements.clearBtn.addEventListener('click', clearLogs);

        elements.connectionUrl.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                connect();
            }
        });

        // Auto-focus on URL input
        elements.connectionUrl.focus();

        // Example URL in local storage
        const savedUrl = localStorage.getItem('sysmedic-websocket-url');
        if (savedUrl) {
            elements.connectionUrl.value = savedUrl;
        }

        // Save URL to local storage when connecting
        elements.connectBtn.addEventListener('click', function() {
            const url = elements.connectionUrl.value.trim();
            if (url) {
                localStorage.setItem('sysmedic-websocket-url', url);
            }
        });

        log('Interactive WebSocket client ready. Enter your SysMedic connection URL to begin.', 'info');
        log('Once connected, you can request specific information using the buttons above.', 'info');
    </script>
</body>
</html>
